#50
# Chapter 3
What is Railties?

#51
# railties.gemspec
## https://github.com/rails/rails/blob/master/railties/railties.gemspec#L7-L8
s.summary     = 'Tools for creating, working with, and running Rails applications.'
s.description = 'Rails internals: application bootup, plugins, generators, and rake tasks.'

#52
# railties.gemspec
## https://github.com/rails/rails/blob/master/railties/railties.gemspec#L18
s.files       = Dir['CHANGELOG.md', 'README.rdoc', 'RDOC_MAIN.rdoc', 'bin/**/*', 'lib/']
s.executables = ['rails']

#53
# railties/lib
## https://github.com/rails/rails/tree/master/railties/lib

#54
# rails/commands.rb
## https://github.com/rails/rails/blob/master/railties/lib/rails/commands.rb#L16-L18
require 'rails/commands/commands_tasks'
Rails::CommandsTasks.new(ARGV).run_command!(command)

#55
# rails/commands.rb
Requires 'rails/commands/commands_tasks'
Invokes a command task with the given name

#56
# rails/commands/commands_tasks.rb
## https://github.com/rails/rails/blob/master/railties/lib/rails/commands/commands_tasks.rb#L74
module Rails
  class CommandsTasks

    def server
      set_application_directory!
      require_command!("server")

      Rails::Server.new.tap do |server|
        ...
        server.start
      end
    end

  end
end

#57
# CommandsTasks#server
Requires 'rails/commands/server'

#58
# rails/commands/server.rb
## https://github.com/rails/rails/blob/master/railties/lib/rails/commands/server.rb#L4
require 'rails'

module Rails
  class Server < ::Rack::Server

    def initialize(*)
      super
      ENV["RAILS_ENV"] ||= options[:environment]
    end

    def start
      ...
      super
    end

  end
end

#59
# rails/commands/server.rb
Requires 'rails'

#60
# require 'rails'
Requires rails.rb file at the top of lib directory

#61
# rails.rb
## https://github.com/rails/rails/blob/master/railties/lib/rails.rb#L11
require 'rails/application'

module Rails
  ...
end

#62
# rails.rb
Requires 'rails/application'
Defines a top-level module named Rails

#63
# rails/application.rb
## https://github.com/rails/rails/blob/master/railties/lib/rails/application.rb#L6
require 'rails/engine'
module Rails
  class Application < Engine
    ...
  end
end

#64
# rails/application.rb
Requires 'rails/engine'
Defines Rails::Application class inheriting Rails::Engine

#65
# rails/engine.rb
## https://github.com/rails/rails/blob/master/railties/lib/rails/engine.rb#L1
require 'rails/railtie'
module Rails
  class Engine < Railtie
    ...
  end
end

#66
# rails/engine.rb
Requires 'rails/railtie'
Defines Rails::Engine class inheriting Rails::Railtie

#67
# rails/railtie.rb
## https://github.com/rails/rails/blob/master/railties/lib/rails/railtie.rb#L1-L2
require 'rails/initializable'
require 'rails/configuration'

module Rails
  class Railtie
    include Initializable
    ...
  end
end

#68
# rails/railtie.rb
Requires 'rails/initializable'
Requires 'rails/configuration'
Defines Rails::Railtie class that includes Rails::Initializable

#69
# rails/initializable.rb
## https://github.com/rails/rails/blob/master/railties/lib/rails/initializable.rb
module Rails
  module Initializable
    class Initializer
      ...
    end
  end
end

#70
Defines Rails::Initializable
Defines Rails::Initializable::Initializer

#71
# What we learned
Railties defines these core classes
MyApp::Application < Application < Engine < Railtie < Initializable

#72
# Railties is the core of Rails
It's a library providing something underneath the Rails Application
So all MVC components in Rails use Rails::Railtie class under the hood

#81
# Railties in Rails
Each component has its own Railtie inheriting Rails::Railtie
- https://github.com/rails/rails/blob/master/actionmailer/lib/action_mailer/railtie.rb#L7
- https://github.com/rails/rails/blob/master/actionpack/lib/action_controller/railtie.rb#L9
- https://github.com/rails/rails/blob/master/actionpack/lib/action_dispatch/railtie.rb#L4
- https://github.com/rails/rails/blob/master/actionview/lib/action_view/railtie.rb#L6
- https://github.com/rails/rails/blob/master/activejob/lib/active_job/railtie.rb#L6
- https://github.com/rails/rails/blob/master/activemodel/lib/active_model/railtie.rb#L5
- https://github.com/rails/rails/blob/master/activerecord/lib/active_record/railtie.rb#L13
- https://github.com/rails/rails/blob/master/activesupport/lib/active_support/railtie.rb#L5

#85
# What's written in a Railtie?
module ActiveModel
  class Railtie < Rails::Railtie # :nodoc:
    config.eager_load_namespaces << ActiveModel

    initializer "active_model.secure_password" do
      ActiveModel::SecurePassword.min_cost = Rails.env.test?
    end
  end
end

#86
# What's written in a Railtie?
Mainly we see two kinds of class method calls: config and initializer

#88
# What is config?
## https://github.com/rails/rails/blob/master/railties/lib/rails/railtie.rb#L213-L215
module Rails
  class Railtie

    def config
      @config ||= Railtie::Configuration.new
    end

  end
end

#89
# What is config?
It's an instance of Railtie::Configuration

#90
# Railtie::Configuration
## https://github.com/rails/rails/blob/master/railties/lib/rails/railtie/configuration.rb#L89-L97
module Rails
  class Railtie
    class Configuration

      def method_missing(name, *args, &blk)
        if name.to_s =~ /=$/
          @@options[$`.to_sym] = args.first
        elsif @@options.key?(name)
          @@options[name]
        else
          super
        end
      end

    end
  end
end

#91
# Railtie::Configuration
It accepts any method call and stores the given method name & value in a class level Hash as {method_name: value}

#93
# What is initializer?
## https://github.com/rails/rails/blob/master/railties/lib/rails/initializable.rb#L85
module Rails
  module Initializable
    class Initializer
      attr_reader :name, :block

      def initialize(name, context, options, &block)
        options[:group] ||= :default
        @name, @context, @options, @block = name, context, options, block
      end
    end

    module ClassMethods
      def initializer(name, opts = {}, &blk)
        ...
        initializers << Initializer.new(name, nil, opts, &blk)
      end
    end
  end
end

#94
# What is initializer?
It just keeps the given block as a Proc instance (with a name and options)

#95
# What Railtie is doing
- Setting some values via config.foobar = 'baz'
- Storing Procs given to initializer method calls

#99
# What's gonna happen when Rails::Railtie is inherited?
module Rails
  class Railtie

    def self.inherited(base)
      subclasses << base unless base.abstract_railtie?
    end

  end
end

- Rails::Railtie memorizes the children classes
- It can't instantiate, in order to be able to be inherited

#102
# Summary: What is Railties?
- Railties is the core of Rails that provides Railtie, Engine, Application, etc..
- We can find 'Railties' in other Rails components
- A 'Railtie' can keep 'config' and 'initializer' values
- Railties ties up these 'Railties'
