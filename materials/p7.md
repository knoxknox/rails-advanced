#191
# Chapter 7
Controllers and actions

#193
# What happens when the server got a request?
## https://github.com/rails/rails/blob/master/actionpack/lib/action_dispatch/routing/route_set.rb#L72-L74
module ActionDispatch
  module Routing
    class RouteSet
      class Dispatcher < Routing::Endpoint

      def serve(req)
        ...
        env = req.env
        action = params.fetch(:action)
        dispatch(controller, action, env)
      end

      def dispatch(controller, action, env)
        controller.action(action).call(env)
      end

      end
    end
  end
end

#194
# Creating a Request object
## https://github.com/rails/rails/blob/master/actionpack/lib/action_controller/metal.rb#L235-L243
module ActionController
  class Metal < AbstractController::Base

    def self.action(name, klass = ActionDispatch::Request)
      if middleware_stack.any?
        middleware_stack.build(name) do |env|
          new.dispatch(name, klass.new(env))
        end
      else
        lambda { |env| new.dispatch(name, klass.new(env)) }
      end
    end

  end
end

#195
# Creating a response object
## https://github.com/rails/rails/blob/master/actionpack/lib/action_controller/metal/rack_delegation.rb#L33-L36
module ActionController
  module RackDelegation

    def response
      ActionDispatch::Response
    end

    def set_response!(request)
      @_response = response.new
      @_response.request = request
    end

  end
end

#196
# ActionController::Metal#dispatch
## https://github.com/rails/rails/blob/master/actionpack/lib/action_controller/metal.rb#L192-L196
module ActionController
  class Metal < AbstractController::Base

    def dispatch(name, request)
      set_request!(request)
      process(name)
      to_a
    end

    def set_request!(request)
      @_env = request.env
      @_request = request
      @_env['action_controller.instance'] = self
    end

    def to_a
      response ? response.to_a : [status, headers, response_body]
    end

  end
end

#198
# Controller#process(name)
## https://github.com/rails/rails/blob/master/actionpack/lib/abstract_controller/base.rb#L128
module AbstractController
  class Base

    def process(action, *args)
      ...
      process_action(action_name, *args)
    end

    def process_action(method_name, *args)
      send_action(method_name, *args) # alias send_action send
    end

  end
end

#200
# Summary: Controllers and actions
- The request goes to FooController.action('bar')
- FooController.action('bar') sets the Rails Request and Response objects to the controller instance
- Then call goes to FooController#bar via `send` call (alias send is defined for method `send_action`)
