#103
# Chapter 4
How Rails server boots (2)

#104
# rails/commands/commands_tasks.rb
## https://github.com/rails/rails/blob/master/railties/lib/rails/commands/commands_tasks.rb#L81
module Rails
  class CommandsTasks

    def server
      set_application_directory!
      require_command!("server")

      Rails::Server.new.tap do |server|
        ...
        server.start
      end
    end

  end
end

#105
# CommandsTasks#server
Requires 'rails/commands/server'

#106
# rails/commands/server.rb
## https://github.com/rails/rails/blob/master/railties/lib/rails/commands/server.rb#L66-L77
module Rails
  class Server < ::Rack::Server

    def start
      ...
      super
    end

  end
end

#107
# rails/commands/server.rb
Calls ::Rack::Server#start via super()

#108
# rack/lib/rack/server.rb
## https://github.com/rack/rack/blob/master/lib/rack/server.rb#L257-L297
module Rack
  class Server

    def start &blk
      ...
      server.run wrapped_app, options, &blk
    end

  end
end

#111
# Rack finally executes something like this
## https://github.com/rack/rack/blob/master/lib/rack/builder.rb#L48-L51
eval "Rack::Builder.new {\n" + builder_script + "\n}.to_app", TOPLEVEL_BINDING, file, 0

#112
# Rack::Builder.new
## https://github.com/rack/rack/blob/master/lib/rack/builder.rb#L53-L56
module Rack
  class Builder

    def initialize(default_app = nil,&block)
      ...
      instance_eval(&block) if block_given?
    end

  end
end

#113
# Rails.root/config.ru
require ::File.expand_path('../config/environment',  __FILE__)
run Rails::Application

#114
# Rails.root/config.ru
Requires Rails.root/config/environment.rb
Runs Rails::Application

This file is used by Rack-based servers to start the application

#120
# Rails.root/config/environment.rb
require File.expand_path('../application', __FILE__)
Rails::Application.initialize!

#121
# Rails.root/config/environment.rb
Requires Rails.root/config/application.rb
Calls Rails::Application.initialize!

#122
# Rails.root/config/application.rb
require 'rails/all'
Bundler.require(*Rails.groups)
class Application < Rails::Application
end

#123
# Rails.root/config/application.rb
Requires 'rails/all'
Requires bundled gems
Defines rails application

#125
# rails/all.rb
## https://github.com/rails/rails/blob/master/railties/lib/rails/all.rb#L4-L10
require 'active_record/railtie'
require 'action_controller/railtie'
require 'action_view/railtie'
require 'action_mailer/railtie'
require 'active_job/railtie'
require 'rails/test_unit/railtie'
require 'sprockets/railtie'

Each railtie defines configs and initializers, as we have seen already

#128
# Rails::Application.initialize!
## https://github.com/rails/rails/blob/master/railties/lib/rails/application.rb#L351-L356
module Rails
  class Application < Engine

    def initialize!(group=:default)
      ...
      run_initializers(group, self)
    end

  end
end

#129
# Rails::Application.initialize!
Calls run_initializers

#130
# run_initializers
## https://github.com/rails/rails/blob/master/railties/lib/rails/initializable.rb#L52-L58
module Rails
  module Initializable

    def run_initializers(group=:default, *args)
      return if instance_variable_defined?(:@ran)
      initializers.tsort_each do |initializer|
        initializer.run(*args) if initializer.belongs_to?(group)
      end
      @ran = true
    end

  end
end

#131
# How the initializers are run?
Calls #run method for each Initializer object in the initializers collection

#132
# Initializer#run
## https://github.com/rails/rails/blob/master/railties/lib/rails/initializable.rb#L29-L31
module Rails
  module Initializable
    class Initializer

      def run(*args)
        @context.instance_exec(*args, &block)
      end

    end

  end
end

#133
# Initializer#run
@context is actually the application instance
It simply instance_execs the stored Proc in some context stored in @context

#134
# All the Initializers
## https://github.com/rails/rails/blob/master/railties/lib/rails/application.rb#L358-L362
module Rails
  class Application < Engine

    def initializers
      Bootstrap.initializers_for(self) + railties_initializers(super) + Finisher.initializers_for(self)
    end

  end
end

#135
# What's in the initializers collection?
## https://github.com/rails/rails/blob/master/railties/lib/rails/initializable.rb#L82-L86
module Rails
  module Initializable
    module ClassMethods

      def initializer(name, opts = {}, &blk)
        ...
        initializers << Initializer.new(name, nil, opts, &blk)
      end

    end
  end
end

#136
# What's in the initializers collection?
Instances of Rails::Initializable::Initializer
Each Initializer just holds a Proc instance (and a name + options) given to Rails::Railtie::Initializable.initialize method call

#137
# Who calls Rails::Railtie.initialize?
Railtie subclasses such as ActionPack::Railtie, ActiveRecord::Railtie, etc..

#141
# Summary: How Rails server boots (2)
- Require all gems in the Gemfile (bundler)
- Load all Engines and Railties (config/application.rb)
- Define Application < Rails::Application (config/application.rb)
- Run Railtie#initializer defined in each Engine, Railtie, Application
- Load each Engine's load_path and routes, then load config/initializers/*
- Run Rails::Application (config.ru)
