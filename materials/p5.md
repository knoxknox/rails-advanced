#142
# Chapter 5
Building middleware stack

#143
# config.ru
run Rails::Application

#144
# run Rails::Application
With this definition, the Rack server calls Rails::Application.call(env)

#145
# Rails::Application responds_to :call
Rails::Application is a Rack application

#146
# Rails::Application as a Rack application
## https://github.com/rails/rails/blob/master/railties/lib/rails/application.rb#L162-L167
module Rails
  class Application < Engine

    def call(env)
      req = ActionDispatch::Request.new env
      env["ORIGINAL_FULLPATH"] = req.fullpath
      env["ORIGINAL_SCRIPT_NAME"] = req.script_name
      super(env)
    end

  end
end

#147
# Rails::Application#call
Calls super
The super class is Rails::Engine

#148
# Rails::Engine is a Rack application
## https://github.com/rails/rails/blob/master/railties/lib/rails/engine.rb#L513-L519
module Rails
  class Engine < Railtie

    def call(env)
      ...
      app.call(env)
    end

  end
end

#150
# What's app?
## https://github.com/rails/rails/blob/master/railties/lib/rails/engine.rb#L499-L504
module Rails
  class Engine < Railtie

    def app
      @app ||= begin
        config.middleware = config.middleware.merge_into(default_middleware_stack)
        config.middleware.build(endpoint)
      end
    end

  end
end

#151
# What's app?
app is config.middleware that contains default_middleware_stack and endpoint

#152
# What is config.middleware?
## https://github.com/rails/rails/blob/master/railties/lib/rails/engine/configuration.rb#L16-L18
module Rails
  class Engine
    class Configuration < ::Rails::Railtie::Configuration

      def middleware
        @middleware ||= Rails::Configuration::MiddlewareStackProxy.new
      end

  end
end

#153
# What is Rails::Configuration::MiddlewareStackProxy?
## https://github.com/rails/rails/blob/master/railties/lib/rails/configuration.rb#L36-L39
module Rails
  module Configuration
    class MiddlewareStackProxy

      def initialize
        @operations = []
        @delete_operations = []
      end

    end
  end
end

#154
# What is Rails::Configuration::MiddlewareStackProxy?
Basically it's a stack that proxies the Rails middleware stack

#156
# What is the endpoint?
## https://github.com/rails/rails/blob/master/railties/lib/rails/engine.rb#L508-L510
module Rails
  class Engine < Railtie

    def endpoint
      self.class.endpoint || routes
    end

    def routes
      @routes ||= ActionDispatch::Routing::RouteSet.new_with_config(config)
      @routes.append(&Proc.new) if block_given?
      @routes
    end

  end
end

#157
# What is the endpoint?
By default endpoint is ActionDispatch::Routing::RouteSet

#158
# Summary: Building middleware stack
- The Rack server calls Rails::Application.call
- It calls the Rails default middleware stack and the endpoint
- The endpoint is 'routes'
