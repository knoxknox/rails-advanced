#159
# Chapter 6
Routes

#160
# Rails.application.routes
Usually written in Rails.root/config/routes.rb

#161
# An example routes.rb
Rails.application.routes.draw do
  get '/hello' => 'foo#bar'
end

#162
# What is routes?
Rails.application.routes.class
=> ActionDispatch::Routing::RouteSet

#163
# Rails.application.routes
## https://github.com/rails/rails/blob/master/actionpack/lib/action_dispatch/routing/route_set.rb#L766-L770
module ActionDispatch
  module Routing
    class RouteSet

      def call(env)
        ...
        @router.serve(req)
      end

      def request_class
        ActionDispatch::Request
      end

    end
  end
end

#164
# What is @router?
## https://github.com/rails/rails/blob/master/actionpack/lib/action_dispatch/routing/route_set.rb#L334-L349
module ActionDispatch
  module Routing
    class RouteSet

      def initialize(config = DEFAULT_CONFIG)
        ...
        @set    = Journey::Routes.new
        @router = Journey::Router.new @set
        @formatter = Journey::Formatter.new @set
      end

    end
  end
end

#165
# What is @router?
It's a Journey thing!
This is how Rails endpoint accepts the Rack request

#168
# Defining routes
## https://github.com/rails/rails/blob/master/actionpack/lib/action_dispatch/routing/route_set.rb#L374-L385
module ActionDispatch
  module Routing
    class RouteSet

      def draw(&block)
        ...
        eval_block(block)
        ...
      end

      def eval_block(block)
        ...
        mapper = Mapper.new(self)
        mapper.instance_exec(&block)
      end

    end
  end
end

#169
# Defining routes
instance_execs the whole given block with an instance of ActionDispatch::Routing::Mapper

#171
# ActionDispatch::Routing::Mapper#get
## https://github.com/rails/rails/blob/master/actionpack/lib/action_dispatch/routing/mapper.rb#L633-L635
module ActionDispatch
  module Routing
    class Mapper

      def get(*args, &block)
        map_method(:get, args, &block)
      end

      def map_method(method, args, &block)
        ...
        match(*args, options, &block)
        ...
      end

      def match(path, *rest)
        ...
        decomposed_match(_path, route_options)
        ...
      end

      def decomposed_match(path, options)
        ...
        add_route(path, options)
        ...
      end

    end
  end
end

#173
# ActionDispatch::Routing::Mapper#add_route
## https://github.com/rails/rails/blob/master/actionpack/lib/action_dispatch/routing/mapper.rb#L1525-L1546
module ActionDispatch
  module Routing
    class Mapper

      def add_route(action, options)
        ...
        mapping = Mapping.build(@scope, @set, URI.parser.escape(path), as, options)
        app, conditions, requirements, defaults, as, anchor = mapping.to_route
        @set.add_route(app, conditions, requirements, defaults, as, anchor)
      end

    end
  end
end

#174
# ActionDispatch::Routing::Mapper#add_route
## https://github.com/rails/rails/blob/master/actionpack/lib/action_dispatch/journey/routes.rb#L62-L71
Routing::Mapper#add_route returns a Journey::Route

module ActionDispatch
  module Journey
    class Routes

      def add_route(app, path, conditions, defaults, name = nil)
        route = Route.new(name, app, path, conditions, defaults)

        route.precedence = routes.length
        routes << route
        named_routes[name] = route if name && !named_routes[name]
        partition_route(route)
        clear_cache!
        route
      end

    end
  end
end

#175
# ActionDispatch::Routing::Mapper#add_route
Makes a Mapper#to_route call
Finally adds a new Journey::Route to routes

#176
# ActionDispatch::Routing::Mapper#to_route
## https://github.com/rails/rails/blob/master/actionpack/lib/action_dispatch/routing/mapper.rb#L126-L128
module ActionDispatch
  module Routing
    class Mapper

      def app(blocks)
        if to.respond_to?(:call)
          Constraints.new(to, blocks, false)
        elsif blocks.any?
          Constraints.new(dispatcher(defaults), blocks, true)
        else
          dispatcher(defaults)
        end
      end

      def to_route
        [ app(@blocks), conditions, requirements, defaults, as, anchor ]
      end

    end
  end
end

#177
# ActionDispatch::Routing::Mapper::Constraints.new
## https://github.com/rails/rails/blob/master/actionpack/lib/action_dispatch/routing/mapper.rb#L16-L57
module ActionDispatch
  module Routing
    module Mapper
      class Constraints < Endpoint

        def initialize(app, constraints, dispatcher_p)
          ...
          @dispatcher = dispatcher_p
          @app, @constraints, = app, constraints
        end

        def serve(req)
          ...
          if dispatcher?
            @app.serve(req) # @app is dispatcher(defaults)
          else
            @app.call(req.env) # @app is to (to.respond_to?(:call))
          end
        end

      end
    end
  end
end

#179
# ActionDispatch::Routing::Mapper::Constraints#serve
An app instance can be a Rack app or a mounted Engine

#181
# What is dispatcher(defaults)?
## https://github.com/rails/rails/blob/master/actionpack/lib/action_dispatch/routing/route_set.rb#L402-L404
module ActionDispatch
  module Routing
    class RouteSet

      def dispatcher(defaults)
        Routing::RouteSet::Dispatcher.new(defaults)
      end

    end
  end
end

#181
# What is dispatcher(defaults)?
## https://github.com/rails/rails/blob/master/actionpack/lib/action_dispatch/routing/mapper.rb#L338-L340
It's an instance of Routing::RouteSet::Dispatcher

#182
# ActionDispatch::Routing::RouteSet::Dispatcher#serve
## https://github.com/rails/rails/blob/master/actionpack/lib/action_dispatch/routing/route_set.rb#L31-L43
module ActionDispatch
  module Routing
    class RouteSet
      class Dispatcher < Routing::Endpoint

        def serve(req)
          req.check_path_parameters!
          params = req.path_parameters
          ...
          dispatch(controller, params[:action], req.env)
        end

      end
    end
  end
end

#183
# controller.action(action) is a Rack app
## https://github.com/rails/rails/blob/master/actionpack/lib/action_controller/metal.rb#L229-L232
=> FooController.action('bar')
=> #<Proc:0x007fa63e990408@.../action_controller/metal.rb:235>

#184
# get '/hello' => 'foo#bar'
Maps '/hello' to a Proc returned by FooController.action('bar')

#186
# Resolving routes
Rails.application.routes.call(env)

#188
# RouteSet#call => Journey::Router#serve
## https://github.com/rails/rails/blob/master/actionpack/lib/action_dispatch/journey/router.rb#L29-L56
module ActionDispatch
  module Journey
    class Router

      def serve(req)
        ...
        status, headers, body = route.app.serve(req)
        return [status, headers, body] # rack response
        ...
      end

    end
  end
end

#190
# Summary: Routes
- Rails.application.routes is a Rack app
- Each controller's each action is a Rack app
  'foo#bar' becomes a Rack app FooController.action('bar')
